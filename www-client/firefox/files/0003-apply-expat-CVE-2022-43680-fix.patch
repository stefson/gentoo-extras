# HG changeset patch
# User Peter Van der Beken <peterv@propagandism.org>
# Date 1667157123 0
# Node ID 17e2d3feebca47dd347db4c455f2ad8c8ccac028
# Parent  1482522d318edeb8717c36902abb50db94dcfd92
Bug 1797336 - Apply expat CVE-2022-43680 fix. r=mccr8

Differential Revision: https://phabricator.services.mozilla.com/D160676

diff --git a/parser/expat/lib/xmlparse.c b/parser/expat/lib/xmlparse.c
--- a/parser/expat/lib/xmlparse.c
+++ b/parser/expat/lib/xmlparse.c
@@ -1004,16 +1004,24 @@ parserCreate(const XML_Char *encodingNam
   nsAttsVersion = 0;
   nsAttsPower = 0;
 
   poolInit(&tempPool, &(parser->m_mem));
   poolInit(&temp2Pool, &(parser->m_mem));
   parserInit(parser, encodingName);
 
   if (encodingName && !protocolEncodingName) {
+    if (dtd) {
+      // We need to stop the upcoming call to XML_ParserFree from happily
+      // destroying parser->m_dtd because the DTD is shared with the parent
+      // parser and the only guard that keeps XML_ParserFree from destroying
+      // parser->m_dtd is parser->m_isParamEntity but it will be set to
+      // XML_TRUE only later in XML_ExternalEntityParserCreate (or not at all).
+      parser->m_dtd = NULL;
+    }
     XML_ParserFree(parser);
     return NULL;
   }
 
   if (nameSep) {
     ns = XML_TRUE;
     internalEncoding = XmlGetInternalEncodingNS();
     namespaceSeparator = *nameSep;

