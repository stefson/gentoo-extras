# HG changeset patch
# User Mike Hommey <mh+mozilla@glandium.org>
# Date 1631692400 0
# Node ID 1f96f89c6fc825dd31ab9a43f2cff03cd4144626
# Parent  7ade904df34a97c02dfc07ce6547555117d6912c
Bug 1730397 - Apply prost-derive fix for function name collision. r=emilio

This applies https://github.com/tokio-rs/prost/commit/edb1464b71528286a6ce74278af05f19c3e0e820
to our copy of prost 0.6.1.

Differential Revision: https://phabricator.services.mozilla.com/D125507

diff --git a/Cargo.lock b/Cargo.lock
index 20fab1f..486ffcc 100644
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -3836,8 +3836,6 @@ dependencies = [
 [[package]]
 name = "prost-derive"
 version = "0.6.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "537aa19b95acde10a12fec4301466386f757403de4cd4e5b4fa78fb5ecb18f72"
 dependencies = [
  "anyhow",
  "itertools 0.8.2",
diff --git a/Cargo.toml b/Cargo.toml
index 8615b99..cf8de78 100644
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -103,6 +103,9 @@ path = "third_party/rust/autocfg"
 [patch.crates-io.mio]
 path = "third_party/rust/mio"
 
+[patch.crates-io.prost-derive]
+path = "third_party/rust/prost-derive"
+
 # Patch failure 0.1.8 to disable the backtrace feature by default. See bug 1608157.
 [patch.crates-io.failure]
 path = "third_party/rust/failure"
diff --git a/third_party/rust/prost-derive/src/lib.rs b/third_party/rust/prost-derive/src/lib.rs
index c359621..28d7aae 100644
--- a/third_party/rust/prost-derive/src/lib.rs
+++ b/third_party/rust/prost-derive/src/lib.rs
@@ -105,10 +105,8 @@ fn try_message(input: TokenStream) -> Result<TokenStream, Error> {
     let merge = fields.iter().map(|&(ref field_ident, ref field)| {
         let merge = field.merge(quote!(value));
         let tags = field
-            .tags()
-            .into_iter()
-            .map(|tag| quote!(#tag))
-            .intersperse(quote!(|));
+        let tags = field.tags().into_iter().map(|tag| quote!(#tag));
+        let tags = Itertools::intersperse(tags, quote!(|));
         quote! {
             #(#tags)* => {
                 let mut value = &mut self.#field_ident;
