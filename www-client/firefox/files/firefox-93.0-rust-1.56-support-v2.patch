# HG changeset patch
# User Mike Hommey <mh+mozilla@glandium.org>
# Date 1631692400 0
# Node ID 1f96f89c6fc825dd31ab9a43f2cff03cd4144626
# Parent  7ade904df34a97c02dfc07ce6547555117d6912c
Bug 1730397 - Apply prost-derive fix for function name collision. r=emilio

This applies https://github.com/tokio-rs/prost/commit/edb1464b71528286a6ce74278af05f19c3e0e820
to our copy of prost 0.6.1.

Differential Revision: https://phabricator.services.mozilla.com/D125507

diff --git a/Cargo.lock b/Cargo.lock
--- a/Cargo.lock
+++ b/Cargo.lock
@@ -3884,18 +3884,16 @@ checksum = "ce49aefe0a6144a45de32927c77b
 dependencies = [
  "bytes 0.5.6",
  "prost-derive",
 ]
 
 [[package]]
 name = "prost-derive"
 version = "0.6.1"
-source = "registry+https://github.com/rust-lang/crates.io-index"
-checksum = "537aa19b95acde10a12fec4301466386f757403de4cd4e5b4fa78fb5ecb18f72"
 dependencies = [
  "anyhow",
  "itertools 0.8.2",
  "proc-macro2",
  "quote",
  "syn",
 ]
 
diff --git a/Cargo.toml b/Cargo.toml
--- a/Cargo.toml
+++ b/Cargo.toml
@@ -102,8 +102,11 @@ rev = "824fa69756523f2b6d49029fe25de9413
 [patch.crates-io.autocfg]
 path = "third_party/rust/autocfg"
 
 
 # Patch mio 0.6 to use winapi 0.3 and miow 0.3, getting rid of winapi 0.2.
 # There is not going to be new version of mio 0.6, mio now being >= 0.7.11.
 [patch.crates-io.mio]
 path = "third_party/rust/mio"
+
+[patch.crates-io.prost-derive]
+path = "third_party/rust/prost-derive"
diff --git a/third_party/rust/prost-derive/src/lib.rs b/third_party/rust/prost-derive/src/lib.rs
--- a/third_party/rust/prost-derive/src/lib.rs
+++ b/third_party/rust/prost-derive/src/lib.rs
@@ -99,21 +99,18 @@ fn try_message(input: TokenStream) -> Re
         .map(|&(ref field_ident, ref field)| field.encoded_len(quote!(self.#field_ident)));
 
     let encode = fields
         .iter()
         .map(|&(ref field_ident, ref field)| field.encode(quote!(self.#field_ident)));
 
     let merge = fields.iter().map(|&(ref field_ident, ref field)| {
         let merge = field.merge(quote!(value));
-        let tags = field
-            .tags()
-            .into_iter()
-            .map(|tag| quote!(#tag))
-            .intersperse(quote!(|));
+        let tags = field.tags().into_iter().map(|tag| quote!(#tag));
+        let tags = Itertools::intersperse(tags, quote!(|));
         quote! {
             #(#tags)* => {
                 let mut value = &mut self.#field_ident;
                 #merge.map_err(|mut error| {
                     error.push(STRUCT_NAME, stringify!(#field_ident));
                     error
                 })
             },

