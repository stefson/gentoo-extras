# HG changeset patch
# User Mike Hommey <mh+mozilla@glandium.org>
# Date 1549401547 0
# Node ID 7b565c75d34b49827dda08a31846081fde1f2833
# Parent  9820df609ddf5ecda41c78d2535eca1aa33e8234
Bug 1515641 - Check for nasm >= 2.13 for dav1d. r=TD-Linux,nalexander

Depends on D18294

Depends on D18294

Differential Revision: https://phabricator.services.mozilla.com/D15229

diff --git a/media/libdav1d/moz.build b/media/libdav1d/moz.build
index b6c5391..cc493c1 100644
--- a/media/libdav1d/moz.build
+++ b/media/libdav1d/moz.build
@@ -24,8 +24,7 @@ SOURCES += [
     '../../third_party/dav1d/src/thread_task.c',
 ]
 
-# Enable ASM build only on Linux for now.
-if CONFIG['OS_TARGET'] == 'Linux' and (CONFIG['CPU_ARCH'] in ('x86', 'x86_64')):
+if CONFIG['MOZ_DAV1D_ASM']:
     # Default stack aligment is 16 bytes
     DIRS += ['asm']
 
diff --git a/moz.configure b/toolkit/moz.configure
index 266ce41..fe77678 100644
--- a/toolkit/moz.configure
+++ b/toolkit/moz.configure
@@ -461,6 +461,16 @@ def av1(value, target, c_compiler):
     if enabled:
         return True
 
+@depends(target, nasm_version, when=av1 & compile_environment)
+def dav1d_asm(target, nasm_version):
+    if target.os == 'GNU' and target.kernel == 'Linux' and target.cpu in ('x86', 'x86_64'):
+        if nasm_version < '2.13':
+            die('nasm 2.13 or greater is required for AV1 support. '
+                'Either install nasm or add --disable-av1 to your configure options.')
+        return True
+
+
+set_config('MOZ_DAV1D_ASM', dav1d_asm)
 set_config('MOZ_AV1', av1)
 set_define('MOZ_AV1', av1) 
