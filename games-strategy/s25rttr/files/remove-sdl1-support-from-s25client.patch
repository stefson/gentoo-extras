From 5f654d848eb85e1a77b88a61ebb86bb004ceeaa7 Mon Sep 17 00:00:00 2001
From: Alexander Grund <Flamefire@users.noreply.github.com>
Date: Thu, 20 Feb 2020 23:52:09 +0100
Subject: [PATCH 1/3] Remove SDL1 in favor of SDL2

---
 README.md                              |   6 +-
 cmake/Modules/FindSDL_mixer.cmake      |   2 +-
 data/RTTR/texte/de/readme.txt          |   2 +-
 data/RTTR/texte/readme.txt             |   2 +-
 external/full-contrib-msvc.7z          |   4 +-
 external/s25edit                       |   2 +-
 extras/audioDrivers/SDL/AudioSDL.cpp   |   2 +-
 extras/audioDrivers/SDL/CMakeLists.txt |   2 +-
 extras/videoDrivers/CMakeLists.txt     |   1 -
 libs/s25client/CMakeLists.txt          |  10 +-
 libs/s25client/s25client.cpp           |   3 -
 19 files changed, 15 insertions(+), 846 deletions(-)

diff --git a/README.md b/README.md
index e27662e49..dee8389e6 100644
--- a/README.md
+++ b/README.md
@@ -40,10 +40,8 @@ Coverage:
 - git + git-lfs
 - libboost-dev (at least v1.64.0, i.e http://www.boost.org/)
 - libboost-locale-dev, libboost-iostreams-dev, libboost-filesystem-dev, libboost-program-options-dev (at least v1.64.0)
-- libsdl1.2-dev
-- libsdl-mixer1.2-dev
-- libsdl2-dev (optional)
-- libsdl2-mixer-dev (optional)
+- libsdl2-dev
+- libsdl2-mixer-dev
 - licurl-dev (in libcurl4-openssl-dev)
 - libbz2-dev
 - lua5.2-dev
diff --git a/cmake/Modules/FindSDL_mixer.cmake b/cmake/Modules/FindSDL_mixer.cmake
index 71f6542a0..fabf95682 100644
--- a/cmake/Modules/FindSDL_mixer.cmake
+++ b/cmake/Modules/FindSDL_mixer.cmake
@@ -32,7 +32,7 @@ else()
   set(VC_LIB_PATH_SUFFIX lib/x86)
 endif()
 
-if(PACKAGE_FIND_VERSION_MAJOR EQUAL "2")
+if(SDL_mixer_FIND_VERSION VERSION_GREATER_EQUAL 2)
   set(libName SDL2_mixer)
   set(pathSuffixes SDL2 include/SDL2 include)
 else()
diff --git a/data/RTTR/texte/de/readme.txt b/data/RTTR/texte/de/readme.txt
index cd0a166b5..2ad711917 100644
--- a/data/RTTR/texte/de/readme.txt
+++ b/data/RTTR/texte/de/readme.txt
@@ -59,7 +59,7 @@ B. Installation
     Zunächst benötigt man folgende Pakete
     (ggf über Paketmanager/per Hand installieren):
 
-    libsdl1.2 libsdl-mixer1.2 gettext
+    libsdl2 libsdl-mixer2 gettext
 
     Weiterhin sollte man sicherstellen, dass DirectRendering funktioniert:
 
diff --git a/data/RTTR/texte/readme.txt b/data/RTTR/texte/readme.txt
index 26097a3d6..0cf8ed057 100644
--- a/data/RTTR/texte/readme.txt
+++ b/data/RTTR/texte/readme.txt
@@ -57,7 +57,7 @@ B. Installation
     You will need the following packages:
     (Use your package-manager or do it manually)
 
-    libsdl1.2 libsdl-mixer1.2 gettext
+    libsdl2 libsdl-mixer2 gettext
 
     Make sure that DirectRendering works:

diff --git a/extras/audioDrivers/SDL/AudioSDL.cpp b/extras/audioDrivers/SDL/AudioSDL.cpp
index 20648e093..5d467575e 100644
--- a/extras/audioDrivers/SDL/AudioSDL.cpp
+++ b/extras/audioDrivers/SDL/AudioSDL.cpp
@@ -182,7 +182,7 @@ SoundHandle AudioSDL::LoadMusic(const std::vector<char>& data, const std::string
     // Need to copy data as it is used by SDL
     auto* handle = new SoundSDL_Music(data);
     SDL_RWops* rwOps = SDL_RWFromConstMem(&handle->data[0], static_cast<int>(data.size()));
-    Mix_Music* music = Mix_LoadMUS_RW(rwOps);
+    Mix_Music* music = Mix_LoadMUS_RW(rwOps, false);
     if(music == nullptr)
     {
         SDL_FreeRW(rwOps);
diff --git a/extras/audioDrivers/SDL/CMakeLists.txt b/extras/audioDrivers/SDL/CMakeLists.txt
index de8f13a5f..b6d4d7192 100644
--- a/extras/audioDrivers/SDL/CMakeLists.txt
+++ b/extras/audioDrivers/SDL/CMakeLists.txt
@@ -1,5 +1,5 @@
 set(SDL_BUILDING_LIBRARY ON)
-find_package(SDL_mixer)
+find_package(SDL_mixer 2)
 
 if(NOT SDL_MIXER_FOUND)
   message(WARNING "SDL_mixer library not found: Not building SDL audiodriver")

diff --git a/libs/s25client/CMakeLists.txt b/libs/s25client/CMakeLists.txt
index b51851d61..644d9cb57 100644
--- a/libs/s25client/CMakeLists.txt
+++ b/libs/s25client/CMakeLists.txt
@@ -20,15 +20,7 @@ add_executable(s25client s25client.cpp ${s25client_RC})
 target_link_libraries(s25client PRIVATE s25Main Boost::program_options nowide::static)
 add_dependencies(s25client drivers)
 
-if(APPLE)
-    set(SDL_BUILDING_LIBRARY OFF)
-    find_package(SDL REQUIRED)
-	target_include_directories(s25client SYSTEM PRIVATE ${SDL_INCLUDE_DIR})
-    if(NOT SDLMAIN_LIBRARY)
-        set(SDLMAIN_LIBRARY ${PROJECT_SOURCE_DIR}/external/macos/libSDLmain.a)
-    endif()
-    target_link_libraries(s25client PRIVATE ${SDL_LIBRARY} ${SDLMAIN_LIBRARY})
-elseif(WIN32)
+if(WIN32)
     target_include_directories(s25client PRIVATE ${rcDir})
 	target_link_libraries(s25client PRIVATE ole32 ws2_32 shlwapi imagehlp)
     if(MSVC)
diff --git a/libs/s25client/s25client.cpp b/libs/s25client/s25client.cpp
index 939761848..5b6bac7f9 100644
--- a/libs/s25client/s25client.cpp
+++ b/libs/s25client/s25client.cpp
@@ -44,9 +44,6 @@
 #include <limits>
 //#include <vld.h>
 
-#ifdef __APPLE__
-#include <SDL_main.h>
-#endif // __APPLE__
 #ifdef _WIN32
 #include "s25util/ucString.h"
 #include <windows.h>

