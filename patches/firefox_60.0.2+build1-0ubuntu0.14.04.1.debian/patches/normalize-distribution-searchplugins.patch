Description: Normalize the paths to distribution searchplugins so that
 associated metadata is not lost on upgrades (when the install location changes)
Author: Alexander Sack <asac@ubuntu.com>
Bug: https://bugzilla.mozilla.org/show_bug.cgi?id=534663
Forwarded: no
---
 toolkit/components/search/nsSearchService.js |    9 +++++++++
 1 file changed, 9 insertions(+)

--- a/toolkit/components/search/nsSearchService.js
+++ b/toolkit/components/search/nsSearchService.js
@@ -60,6 +60,7 @@
 const PERMS_FILE    = 0o644;
 
 // Directory service keys
+const NS_XPCOM_CURRENT_PROCESS_DIR = "XCurProcD";
 const NS_APP_DISTRIBUTION_SEARCH_DIR_LIST = "SrchPluginsDistDL";
 const NS_APP_USER_PROFILE_50_DIR = "ProfD";
 
@@ -3405,6 +3406,13 @@
       if (!file.isFile() || file.fileSize == 0 || file.isHidden())
         continue;
 
+      var appdirstr = getDir(NS_XPCOM_CURRENT_PROCESS_DIR).path
+                      + "/distribution/searchplugins";
+
+      // normalize distribution searchplugins if they are following links
+      if (file.path.indexOf(appdirstr) == 0)
+        file.normalize();
+
       var fileURL = Services.io.newFileURI(file).QueryInterface(Ci.nsIURL);
       var fileExtension = fileURL.fileExtension.toLowerCase();
 
